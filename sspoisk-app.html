<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Filmoteka">
    
    <title>Filmoteka (SSPoisk)</title>

    <link rel="icon" href="https://yastatic.net/s3/kinopoisk-frontend/common-static/img/hd-favicon/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://yastatic.net/s3/kinopoisk-frontend/common-static/img/hd-favicon/apple-touch-icon-180x180.png" data-tid="FaviconsLinksHd"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">

    <style>
        :root{--bg-color:#202020;--card-bg:#2b2b2b;--light-text:#ececec;--accent:#ff6000;--secondary:#0f0f0f;--search-bg:#2d2d2d;--muted-text:#888;--border:#3a3a3a;--error:#f44;--rating-low:#f22;--rating-med:#fd781f;--rating-high:#ffd000;--radius-sm:5px;--radius-lg:20px}
        *{font-family:"Nunito Sans",sans-serif!important;margin:0;padding:0;box-sizing:border-box}
        body{background:#000;color:var(--light-text);line-height:1.4;overflow-x:hidden}
        .page-container{padding:15px;background:var(--bg-color);min-height:100vh}
        .footer {padding: 30px 50px 60px;max-width:800px;margin:0 auto;font-weight: 300; font-size: 10pt;}
        h1,h2{font-weight:900;color:var(--light-text)}
        h1{text-align:center;margin:20px 0 30px;font-size:28pt}
        h2{text-align:left;font-size:14pt;margin:50px 0 10px}
        a {text-decoration: none; color: var(--accent); font-weight: 900;}
        .section{max-width:800px;margin:0 auto;margin-top:40px}
        .section.hidden{display:none}
        .search-section{position:relative;margin:-15px;padding:20px 0;margin-bottom:40px;background:linear-gradient(to bottom,#000 0%,var(--bg-color) 100%)}
        .search-section::before{content:"";position:absolute;top:0;left:50%;transform:translateX(-50%);width:100vw;height:100%;z-index:-1}
        .search-container{max-width:800px;margin:0 auto;padding:0 15px}
        .search-box{display:flex;gap:8px;margin-bottom:30px}
        .form-input{flex:1;padding:8px 20px;background:var(--search-bg);color:var(--light-text);border:1px solid var(--border);border-radius:var(--radius-lg);outline:none;font-size:10pt;min-width:0}
        .form-input::placeholder{color:var(--muted-text)}
        .btn{padding:8px 20px;color:var(--light-text);border:none;cursor:pointer;border-radius:var(--radius-lg);font-weight:700;font-size:10pt;transition:opacity .2s;text-decoration:none;display:inline-block;white-space:nowrap}
        .btn:hover{opacity:.9}
        .btn--primary{background:var(--accent)}
        .btn--secondary{background:var(--secondary)}
        .btn--danger{background:var(--error)}
        .btn--block{display:block;margin:20px auto}
        .film-item{display:flex;align-items:stretch;padding:15px;margin-bottom:15px;background:var(--card-bg);border-radius:var(--radius-sm);gap:15px;border:1px solid var(--border);height:150px}
        .film-poster{width:80px;height:120px;object-fit:cover;border-radius:var(--radius-sm);flex-shrink:0;align-self:center}
        .film-content{flex:1;display:flex;flex-direction:column;gap:12px;justify-content:space-between;height:120px;position:relative}
        .film-header{display:flex;flex-direction:column;gap:5px;flex:1}
        .film-type{font-size:8pt;font-weight:500;color:var(--muted-text);text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;gap:8px}
        .film-rating{display:inline-flex;align-items:center;gap:3px;font-size:8pt;font-weight:500}
        .rating-value{padding:2px 6px;border-radius:4px;font-weight:700;font-size:8pt;margin-left:-5px}
        .rating-low{color:var(--rating-low)}
        .rating-med{color:var(--rating-med)}
        .rating-high{color:var(--rating-high)}
        .film-title{font-size:10pt;font-weight:900;color:var(--light-text);line-height:1.2}
        .film-year{color:var(--muted-text);font-size:10pt;font-weight:700}
        .film-actions{position:absolute;bottom:0;right:0;text-align:right;display:flex;gap:8px}
        .info-text{text-align:left;color:var(--muted-text);margin-bottom:20px;font-size:10pt;font-weight: 300;}
        .message{text-align:center;padding:40px;font-size:14pt}
        .loading{color:var(--light-text)}
        .error{color:var(--error)}
        .pagination{display:flex;justify-content:center;align-items:center;gap:15px;margin-top:20px}
        .pagination-btn:disabled{opacity:.5;cursor:not-allowed}
        .page-info{color:var(--light-text);font-weight:700}
        .site-info {padding: 30px 50px;max-width:800px;margin:0 auto; font-weight: 900; font-size: 10pt;}
        .spinner{animation:rotate 2s linear infinite;width:50px;height:50px;margin:40px auto}
        .spinner .path{stroke:var(--accent);stroke-linecap:round;animation:dash 1.5s ease-in-out infinite}
        @keyframes rotate {100%{transform:rotate(360deg)}}
        @keyframes dash {0%{stroke-dasharray:1,150;stroke-dashoffset:0}50%{stroke-dasharray:90,150;stroke-dashoffset:-35}100%{stroke-dasharray:90,150;stroke-dashoffset:-124}}
    </style>
</head>
<body>
    <div class="page-container">
        <div class="search-section">
            <div class="search-container">
                <h1>Фильмотека</h1>
                <div class="search-box">
                    <input type="text" id="searchInput" class="form-input" placeholder="Найти фильм или сериал...">
                    <button id="searchBtn" class="btn btn--primary">Поиск</button>
                </div>
                <div id="results"></div>
            </div>
        </div>
        <div class="section hidden" id="similarSection">
            <h2 id="similarTitle">Похожие фильмы</h2>
            <button class="btn btn--primary btn--block" id="backBtn">На главную</button>
            <div id="similarResults"></div>
        </div>
        <div class="section" id="recommendationsSection">
            <h2>Рекомендации</h2>
            <div class="info-text">Лучшие фильмы и сериалы всех времен по версии пользователей КиноПоиска</div>
            <div class="pagination">
                <button id="prevPage" class="btn btn--primary pagination-btn" disabled>◄ Назад</button>
                <span class="page-info">Страница <span id="currentPage">1</span></span>
                <button id="nextPage" class="btn btn--primary pagination-btn">Вперед ►</button>
            </div>
            <br>
            <div id="recommendations"></div>
        </div>
        <br><br>
    </div>
    <div class="footer">
        <h3>Filmoteka [SSPoisk] 2025 ©</h3><br>
        <p>База данных КиноПоиска с полным доступом к просмотру медиаконтента без ограничений.</p><br><br>
        <p>Assembled by <span><a href="https://free-gen.github.io" target="_blank">FREEGEN</a></span></p>
    </div>

    <script>
        const API_KEY = '5bd42146-7679-4016-b124-f278ca89ea1b';
        let isSearchActive = false;
        let top250Cache = {};
        let currentPage = 1;
        const filmsPerPage = 20;
        const totalFilms = 250;

        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('searchInput');
        const resultsDiv = document.getElementById('results');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const similarSection = document.getElementById('similarSection');
        const similarResultsDiv = document.getElementById('similarResults');
        const similarTitle = document.getElementById('similarTitle');
        const backBtn = document.getElementById('backBtn');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const currentPageSpan = document.getElementById('currentPage');
        const recommendationsDiv = document.getElementById('recommendations');

        document.addEventListener('DOMContentLoaded', function() {
            loadTop250();
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadTop250();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < Math.ceil(totalFilms / filmsPerPage)) {
                    currentPage++;
                    loadTop250();
                }
            });
        });

        searchBtn.addEventListener('click', toggleSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (isSearchActive) {
                    clearSearch();
                } else {
                    searchFilms();
                }
            }
        });

        backBtn.addEventListener('click', function() {
            hideSimilar();
            showRecommendations();
        });

        function getRatingColor(rating) {
            if (rating >= 0 && rating < 3) return 'rating-low';
            if (rating >= 3 && rating < 6) return 'rating-med';
            if (rating >= 6 && rating <= 10) return 'rating-high';
            return 'rating-low';
        }

        function formatRating(rating) {
            if (!rating || rating === 'null') return null;
            const numRating = parseFloat(rating);
            return isNaN(numRating) ? null : numRating.toFixed(1);
        }

        function updateSearchButton() {
            if (isSearchActive) {
                searchBtn.textContent = 'Закрыть';
                searchBtn.classList.add('btn--danger');
            } else {
                searchBtn.textContent = 'Поиск';
                searchBtn.classList.remove('btn--danger');
            }
        }

        function hideRecommendations() {
            recommendationsSection.classList.add('hidden');
        }

        function showRecommendations() {
            recommendationsSection.classList.remove('hidden');
        }

        function hideSimilar() {
            similarSection.classList.add('hidden');
        }

        function showSimilar() {
            similarSection.classList.remove('hidden');
        }

        function updatePagination() {
            currentPageSpan.textContent = currentPage;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage >= Math.ceil(totalFilms / filmsPerPage);
        }

        function createFilmItem(film, options = {}) {
            const {
                showPosition = false,
                position = 0,
                customType = null
            } = options;
            
            const filmId = film.kinopoiskId || film.filmId;
            const title = film.nameRu || film.nameEn || 'Без названия';
            const year = film.year || 'Неизвестно';
            const poster = film.posterUrlPreview || film.posterUrl || '';
            
            const filmType = film.type || film.filmType || 'FILM';
            const isSeries = filmType === 'TV_SERIES' || filmType === 'MINI_SERIES' || filmType === 'TV_SHOW';
            const typeText = customType || (isSeries ? 'Сериал' : 'Фильм');
            
            const rating = formatRating(film.rating || film.ratingKinopoisk || film.ratingImdb);
            const ratingColor = rating ? getRatingColor(rating) : '';
            const ratingDisplay = rating ? 
                `<span class="film-rating">| Рейтинг: <span class="rating-value ${ratingColor}">${rating}</span></span>` : 
                '';
            
            const positionDisplay = showPosition ? `#${position} ` : '';
            
            return `
                <div class="film-item">
                    <img src="${poster}" alt="${title}" class="film-poster" onerror="this.style.display='none'">
                    <div class="film-content">
                        <div class="film-header">
                            <div class="film-type">${positionDisplay}${typeText} ${ratingDisplay}</div>
                            <div class="film-title">${title}</div>
                            ${year && year !== 'Неизвестно' ? `<div class="film-year">${year} год</div>` : ''}
                        </div>
                        <div class="film-actions">
                            <button class="btn btn--secondary" onclick="showSimilarFilms(${filmId}, '${title.replace(/'/g, "\\'")}')">
                                Похожие
                            </button>
                            <button class="btn btn--primary" onclick="watchFilm(${filmId})">
                                Смотреть
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayFilms(container, films, options = {}) {
            if (!films || films.length === 0) {
                container.innerHTML = '<div class="message error">Фильмы не найдены</div>';
                return;
            }

            container.innerHTML = films.map((film, index) => {
                const position = options.startPosition ? (options.startPosition + index) : (index + 1);
                return createFilmItem(film, {
                    showPosition: options.showPosition || false,
                    position: position,
                    customType: options.customType || null
                });
            }).join('');
        }

        function toggleSearch() {
            if (isSearchActive) {
                clearSearch();
            } else {
                searchFilms();
            }
        }

        function clearSearch() {
            searchInput.value = '';
            resultsDiv.innerHTML = '';
            isSearchActive = false;
            updateSearchButton();
            showRecommendations();
        }

        async function searchFilms() {
            const query = searchInput.value.trim();
            if (!query) return;

            isSearchActive = true;
            updateSearchButton();
            hideRecommendations();
            hideSimilar();
            
            resultsDiv.innerHTML = '<div class="message loading"><svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg></div>';

            try {
                const url = `https://kinopoiskapiunofficial.tech/api/v2.1/films/search-by-keyword?keyword=${encodeURIComponent(query)}&page=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'X-API-KEY': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Ошибка поиска');
                
                const data = await response.json();
                const limitedFilms = data.films.slice(0, 10);
                displayFilms(resultsDiv, limitedFilms);
                
            } catch (error) {
                resultsDiv.innerHTML = '<div class="message error">Ошибка при поиске фильмов</div>';
            }
        }

        async function loadTop250() {
            if (top250Cache[currentPage]) {
                displayTop250(top250Cache[currentPage]);
                updatePagination();
                return;
            }

            recommendationsDiv.innerHTML = '<div class="message loading"><svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg></div>';
            
            try {
                const movies = await fetchTop250(currentPage);
                top250Cache[currentPage] = movies;
                displayTop250(movies);
                updatePagination();
            } catch (error) {
                console.error('Error loading top 250:', error);
                recommendationsDiv.innerHTML = '<div class="message error">Ошибка при загрузке Топ-250</div>';
            }
        }

        async function fetchTop250(page = 1) {
            try {
                const url = `https://kinopoiskapiunofficial.tech/api/v2.2/films/top?type=TOP_250_BEST_FILMS&page=${page}`;
                
                const response = await fetch(url, {
                    headers: {
                        'X-API-KEY': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Ошибка загрузки Топ-250');
                
                const data = await response.json();
                return data.films || [];
                
            } catch (error) {
                console.error('Error fetching top 250:', error);
                throw error;
            }
        }

        function displayTop250(movies) {
            const startPosition = (currentPage - 1) * filmsPerPage + 1;
            displayFilms(recommendationsDiv, movies, {
                showPosition: true,
                startPosition: startPosition
            });
        }

        async function showSimilarFilms(filmId, filmTitle) {
            clearSearch();
            hideRecommendations();
            hideSimilar();
            
            similarTitle.innerHTML = `<span style="font-size: var(--text-md); font-weight: 700;">${filmTitle}<br>⤷ похожие фильмы</span>`;
            similarResultsDiv.innerHTML = '<div class="message loading"><svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg></div>';
            showSimilar();

            try {
                const url = `https://kinopoiskapiunofficial.tech/api/v2.2/films/${filmId}/similars`;
                const response = await fetch(url, {
                    headers: {
                        'X-API-KEY': API_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Ошибка загрузки похожих фильмов');
                
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const detailedFilms = await loadFilmDetails(data.items.slice(0, 10));
                    displayFilms(similarResultsDiv, detailedFilms);
                } else {
                    similarResultsDiv.innerHTML = '<div class="message error">Похожие фильмы не найдены</div>';
                }
                
            } catch (error) {
                console.error('Error loading similar films:', error);
                similarResultsDiv.innerHTML = '<div class="message error">Ошибка при загрузке похожих фильмов</div>';
            }
        }

        async function loadFilmDetails(films) {
            const detailedFilms = [];
            
            for (const film of films) {
                try {
                    const filmId = film.filmId || film.kinopoiskId;
                    const detailUrl = `https://kinopoiskapiunofficial.tech/api/v2.2/films/${filmId}`;
                    
                    const response = await fetch(detailUrl, {
                        headers: {
                            'X-API-KEY': API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const filmDetails = await response.json();
                        detailedFilms.push(filmDetails);
                    } else {
                        detailedFilms.push(film);
                    }
                } catch (error) {
                    console.error('Error fetching film details:', error);
                    detailedFilms.push(film);
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            return detailedFilms;
        }

        function watchFilm(filmId) {
            window.location.href = `https://sspoisk.ru/film/${filmId}/`;
        }
    </script>
</body>
</html>